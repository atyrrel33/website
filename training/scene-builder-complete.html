<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 5 S's - Scene Builder</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600&display=swap');

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Jost', sans-serif;
background: #0a0a0a;
color: #ffffff;
min-height: 100vh;
position: relative;
}

.gradient-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: radial-gradient(ellipse at center,
rgba(26, 71, 42, 0.6) 0%,
rgba(45, 80, 55, 0.4) 25%,
rgba(13, 35, 20, 0.8) 40%,
rgba(8, 20, 12, 0.95) 70%);
z-index: 0;
animation: breathe 4s infinite alternate ease-in-out;
}

@keyframes breathe {
0% { opacity: 0.4; }
100% { opacity: 0.6; }
}

.container {
position: relative;
z-index: 1;
max-width: 1400px;
margin: 0 auto;
padding: 2rem;
}

/* Header */
.header {
text-align: center;
margin-bottom: 2rem;
padding: 1.5rem;
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
backdrop-filter: blur(10px);
}

.header h1 {
font-size: 2rem;
font-weight: 300;
letter-spacing: 6px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.5rem;
}

.header p {
font-size: 0.9rem;
opacity: 0.7;
letter-spacing: 1px;
}

/* View Container */
.view {
display: none;
}

.view.active {
display: block;
}

/* Scene Library */
.library-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
}

.library-title {
font-size: 1.5rem;
font-weight: 300;
letter-spacing: 3px;
color: rgba(220, 180, 80, 0.95);
}

.new-scene-btn {
padding: 1rem 2rem;
background: rgba(26, 71, 42, 0.8);
border: 1px solid rgba(220, 180, 80, 0.6);
border-radius: 8px;
color: rgba(220, 180, 80, 0.95);
cursor: pointer;
font-family: 'Jost', sans-serif;
font-size: 1rem;
letter-spacing: 1px;
text-transform: uppercase;
transition: all 0.3s ease;
}

.new-scene-btn:hover {
background: rgba(26, 71, 42, 1);
box-shadow: 0 8px 20px rgba(220, 180, 80, 0.3);
transform: translateY(-2px);
}

.scene-grid {
display: grid;
gap: 1rem;
}

.scene-card {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 12px;
padding: 1.5rem;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
justify-content: space-between;
align-items: center;
}

.scene-card:hover {
border-color: rgba(220, 180, 80, 0.6);
transform: translateY(-2px);
}

.scene-info {
flex: 1;
}

.scene-title-card {
font-size: 1.2rem;
font-weight: 400;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.5rem;
}

.scene-meta {
font-size: 0.85rem;
opacity: 0.6;
display: flex;
gap: 1.5rem;
}

.scene-status {
display: inline-block;
padding: 0.3rem 0.8rem;
background: rgba(26, 71, 42, 0.5);
border: 1px solid rgba(26, 71, 42, 0.7);
border-radius: 20px;
font-size: 0.75rem;
letter-spacing: 1px;
text-transform: uppercase;
}

.scene-status.setup { border-color: rgba(220, 180, 80, 0.4); }
.scene-status.capturing { border-color: rgba(100, 180, 120, 0.6); }
.scene-status.finalized { border-color: rgba(180, 100, 220, 0.6); }
.scene-status.exported { border-color: rgba(220, 180, 80, 0.8); }

.scene-actions {
display: flex;
gap: 0.5rem;
}

.icon-btn {
padding: 0.5rem 1rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 6px;
cursor: pointer;
transition: all 0.2s ease;
font-size: 0.85rem;
color: #ffffff;
}

.icon-btn:hover {
background: rgba(26, 71, 42, 0.6);
}

.icon-btn.delete:hover {
background: rgba(120, 20, 20, 0.6);
border-color: rgba(220, 80, 80, 0.6);
}

/* Scene Setup */
.setup-container {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 1.5rem;
}

.setup-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.4);
}

.setup-title {
font-size: 1.5rem;
font-weight: 300;
letter-spacing: 3px;
color: rgba(220, 180, 80, 0.95);
}

.form-section {
margin-bottom: 2rem;
}

.form-section h3 {
font-size: 1.1rem;
font-weight: 400;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.9);
margin-bottom: 1rem;
text-transform: uppercase;
}

.form-field {
margin-bottom: 1.5rem;
}

.form-field label {
display: block;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
margin-bottom: 0.5rem;
}

.form-field input,
.form-field textarea,
.form-field select {
width: 100%;
padding: 1rem;
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
color: #ffffff;
font-family: 'Jost', sans-serif;
font-size: 1rem;
}

.form-field textarea {
min-height: 80px;
resize: vertical;
}

.form-field input:focus,
.form-field textarea:focus,
.form-field select:focus {
outline: none;
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 10px rgba(220, 180, 80, 0.2);
}

.character-list {
display: grid;
gap: 1rem;
margin-top: 1rem;
}

.character-item {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
padding: 1.5rem;
margin-bottom: 1rem;
display: flex;
justify-content: space-between;
align-items: start;
}

.character-details {
flex: 1;
}

.character-name {
font-weight: 500;
color: rgba(220, 180, 80, 0.95);
font-size: 1.1rem;
margin-bottom: 0.5rem;
}

.character-info {
font-size: 0.9rem;
opacity: 0.7;
margin-bottom: 0.3rem;
}

.character-actions {
display: flex;
gap: 0.5rem;
}

.add-btn {
padding: 0.8rem 1.5rem;
background: rgba(26, 71, 42, 0.5);
border: 1px solid rgba(26, 71, 42, 0.7);
border-radius: 8px;
color: rgba(220, 180, 80, 0.95);
cursor: pointer;
font-family: 'Jost', sans-serif;
font-size: 0.95rem;
letter-spacing: 1px;
transition: all 0.3s ease;
}

.add-btn:hover {
background: rgba(26, 71, 42, 0.8);
border-color: rgba(220, 180, 80, 0.5);
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
}

.btn-group {
display: flex;
gap: 1rem;
justify-content: flex-end;
margin-top: 2rem;
}

.btn {
padding: 1rem 2rem;
border: 1px solid;
border-radius: 8px;
cursor: pointer;
font-family: 'Jost', sans-serif;
font-size: 1rem;
letter-spacing: 1px;
text-transform: uppercase;
transition: all 0.3s ease;
}

.btn-primary {
background: rgba(26, 71, 42, 0.8);
border-color: rgba(220, 180, 80, 0.6);
color: rgba(220, 180, 80, 0.95);
}

.btn-primary:hover {
background: rgba(26, 71, 42, 1);
box-shadow: 0 8px 20px rgba(220, 180, 80, 0.3);
transform: translateY(-2px);
}

.btn-secondary {
background: rgba(0, 0, 0, 0.3);
border-color: rgba(26, 71, 42, 0.6);
color: #ffffff;
}

.btn-secondary:hover {
background: rgba(26, 71, 42, 0.4);
}

/* Capture View */
.capture-panel {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 1.5rem;
}

.capture-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.4);
}

.capture-title {
font-size: 1.5rem;
font-weight: 300;
letter-spacing: 3px;
color: rgba(220, 180, 80, 0.95);
}

.beat-counter {
font-size: 1rem;
letter-spacing: 1px;
color: rgba(220, 180, 80, 0.9);
}

.beats-list {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.5) 0%, rgba(8, 18, 12, 0.7) 100%);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}

.beats-list h3 {
font-size: 1.1rem;
font-weight: 400;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.9);
margin-bottom: 1rem;
text-transform: uppercase;
}

.beat-item {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.3);
border-radius: 8px;
padding: 1rem;
margin-bottom: 1rem;
}

.beat-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.8rem;
padding-bottom: 0.8rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.3);
}

.beat-number {
font-weight: 500;
color: rgba(220, 180, 80, 0.95);
}

.beat-content-preview {
font-size: 0.9rem;
opacity: 0.8;
line-height: 1.6;
}

.beat-character {
color: rgba(220, 180, 80, 0.9);
font-weight: 500;
margin-bottom: 0.3rem;
}

.beat-dialogue {
margin-bottom: 0.3rem;
font-style: italic;
}

.beat-action {
opacity: 0.7;
}

/* Finalize View */
.finalize-overview {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 1.5rem;
}

.finalize-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.4);
}

.finalize-title {
font-size: 1.5rem;
font-weight: 300;
letter-spacing: 3px;
color: rgba(220, 180, 80, 0.95);
}

.overview-stats {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 2rem;
}

.stat-box {
text-align: center;
padding: 1.5rem;
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
}

.stat-value {
font-size: 2.5rem;
font-weight: 300;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.5rem;
}

.stat-label {
font-size: 0.9rem;
opacity: 0.7;
text-transform: uppercase;
letter-spacing: 1px;
}

.finalize-content {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.5) 0%, rgba(8, 18, 12, 0.7) 100%);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 12px;
padding: 1.5rem;
}

.beat-editor {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.3);
border-radius: 8px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}

.beat-editor-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
padding-bottom: 1rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.3);
}

.beat-title-edit {
font-size: 1.1rem;
font-weight: 500;
color: rgba(220, 180, 80, 0.95);
}

.s-selector {
display: grid;
grid-template-columns: repeat(5, 1fr);
gap: 0.5rem;
margin-top: 0.5rem;
}

.s-checkbox {
margin-right: 0.5rem;
}

.s-label {
display: flex;
flex-direction: column;
align-items: center;
gap: 0.3rem;
padding: 0.8rem;
background: rgba(26, 71, 42, 0.2);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
cursor: pointer;
transition: all 0.2s ease;
}

.s-label:hover {
background: rgba(26, 71, 42, 0.4);
}

.s-checkbox:checked + .s-label {
background: rgba(26, 71, 42, 0.6);
border-color: rgba(220, 180, 80, 0.6);
}

.s-num {
font-size: 1.5rem;
font-weight: 500;
color: rgba(220, 180, 80, 0.95);
}

.s-name {
font-size: 0.75rem;
opacity: 0.8;
text-align: center;
}

/* Workshop Mode */
.workshop-container {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 1.5rem;
}

.upload-zone {
border: 2px dashed rgba(26, 71, 42, 0.5);
border-radius: 12px;
padding: 3rem;
text-align: center;
cursor: pointer;
transition: all 0.3s ease;
}

.upload-zone:hover {
border-color: rgba(220, 180, 80, 0.6);
background: rgba(26, 71, 42, 0.1);
}

.upload-text {
font-size: 1.1rem;
letter-spacing: 1px;
color: rgba(220, 180, 80, 0.8);
margin-bottom: 0.5rem;
}

.upload-hint {
font-size: 0.85rem;
opacity: 0.6;
}

.workshop-list {
margin-top: 2rem;
}

.workshop-item {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
padding: 1.5rem;
margin-bottom: 1rem;
}

.workshop-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
}

.workshop-scene-title {
font-size: 1.1rem;
font-weight: 400;
color: rgba(220, 180, 80, 0.95);
}

.workshop-notes {
background: rgba(26, 71, 42, 0.2);
border: 1px solid rgba(26, 71, 42, 0.3);
border-radius: 8px;
padding: 1rem;
margin-top: 1rem;
}

.notes-textarea {
width: 100%;
min-height: 100px;
background: transparent;
border: none;
color: #ffffff;
font-family: 'Jost', sans-serif;
resize: vertical;
}

.notes-textarea:focus {
outline: none;
}

/* Utility */
.hidden {
display: none;
}

.text-center {
text-align: center;
}

.empty-state {
text-align: center;
padding: 3rem;
opacity: 0.6;
}


@media (max-width: 768px) {
.container {
padding: 1rem;
}
.form-row {
grid-template-columns: 1fr;
}
.s-selector {
grid-template-columns: repeat(5, 1fr);
gap: 0.3rem;
}
.overview-stats {
grid-template-columns: 1fr 1fr;
}
}
</style>
</head>
<body>
<div class="gradient-bg"></div>

<div class="container">
<div class="header">
<h1>SCENE BUILDER</h1>
<p>The 5 S's Training Tool</p>
</div>

<!-- SCENE LIBRARY VIEW -->
<div id="libraryView" class="view active">
<div class="library-header">
<div class="library-title">Scene Library</div>
<button class="new-scene-btn" onclick="createNewScene()">+ New Scene</button>
</div>
<div id="sceneGrid" class="scene-grid">
<div class="empty-state">No scenes yet. Create your first scene to get started.</div>
</div>
</div>

<!-- SCENE SETUP VIEW -->
<div id="setupView" class="view">
<div class="setup-container">
<div class="setup-header">
<div class="setup-title">Scene Setup</div>
<button class="icon-btn" onclick="backToLibrary()">Back to Library</button>
</div>

<div class="form-section">
<h3>Scene Details</h3>
<div class="form-field">
<label>Scene Title</label>
<input type="text" id="sceneTitle" placeholder="E.g., Closing Time Conflict, Playground Argument, Classroom Disruption">
</div>
<div class="form-row">
<div class="form-field">
<label>Setting Type</label>
<select id="settingType">
<option value="">Choose a setting...</option>
<option value="retail">Retail / Store</option>
<option value="restaurant">Restaurant / Food Service</option>
<option value="school">School / Classroom</option>
<option value="public-space">Park / Public Space</option>
<option value="workplace">Office / Workplace</option>
<option value="transportation">Bus / Subway / Transit</option>
<option value="sports">Sports / Recreation</option>
<option value="home">Home / Family</option>
<option value="street">Street / Neighborhood</option>
<option value="other">Other</option>
</select>
</div>
<div class="form-field">
<label>Specific Location</label>
<input type="text" id="locationName" placeholder="Corner store, Mr. Johnson's class, Wilson Park...">
</div>
</div>
<div class="form-row">
<div class="form-field">
<label>Time Pressure / Urgency</label>
<input type="text" id="timingContext" placeholder="Store closing, class ending, someone's running late...">
</div>
<div class="form-field">
<label>Time of Day</label>
<input type="text" id="timeOfDay" placeholder="9:58 PM, lunch period, after school...">
</div>
</div>
<div class="form-field">
<label>Additional Context</label>
<textarea id="sceneContext" placeholder="What else matters? Environment, neighborhood, history between people, stakes..."></textarea>
</div>
</div>

<div class="form-section">
<h3>Characters</h3>
<p style="opacity: 0.8; margin-bottom: 1.5rem; line-height: 1.6;">Define the people in this scene. Think about what each person wants, their emotional state, and their relationships with others.</p>
<div id="characterList" class="character-list"></div>
<button type="button" class="add-btn" onclick="addCharacter()">+ Add Character</button>
</div>

<div class="btn-group">
<button class="btn btn-primary" onclick="completeSetup()">Complete Setup & Start Capturing</button>
<button class="btn btn-secondary" onclick="saveSetup()">Save Progress</button>
</div>
</div>
</div>

<!-- CAPTURE VIEW -->
<div id="captureView" class="view">
<div class="capture-panel">
<div class="capture-header">
<div class="capture-title">Live Capture</div>
<div>
<span class="beat-counter">Beats: <span id="beatCount">0</span></span>
<button class="icon-btn" onclick="backToLibrary()" style="margin-left: 1rem;">Back to Library</button>
</div>
</div>

<div class="form-field">
<label>Beat Title / Moment</label>
<input type="text" id="beatTitle" placeholder="Customer 2 enters loud on phone">
</div>

<div class="form-row">
<div class="form-field">
<label>Character</label>
<select id="beatCharacter">
<option value="">Select character...</option>
</select>
</div>
<div class="form-field">
<label>Energy / Attitude</label>
<input type="text" id="beatAttitude" placeholder="Aggressive, calm, oblivious...">
</div>
</div>

<div class="form-field">
<label>Dialogue (What They Say)</label>
<textarea id="beatDialogue" placeholder="The exact words spoken..."></textarea>
</div>

<div class="form-field">
<label>Action (What They Do)</label>
<textarea id="beatAction" placeholder="How they say it, what they're doing, body language..."></textarea>
</div>

<div class="btn-group">
<button class="btn btn-primary" onclick="saveBeat()">Save Beat</button>
<button class="btn btn-secondary" onclick="clearBeatForm()">Clear</button>
</div>
</div>

<div class="beats-list">
<h3>Captured Beats</h3>
<div id="beatsList"></div>
</div>

<div class="btn-group">
<button class="btn btn-primary" onclick="moveToFinalize()">Move to Finalize</button>
</div>
</div>

<!-- FINALIZE VIEW -->
<div id="finalizeView" class="view">
<div class="finalize-overview">
<div class="finalize-header">
<div class="finalize-title">Finalize & Tag</div>
<div style="display: flex; gap: 1rem;">
<button class="icon-btn" onclick="backToCapture()">Back to Capture</button>
<button class="icon-btn" onclick="backToLibrary()">Back to Library</button>
</div>
</div>

<div class="overview-stats">
<div class="stat-box">
<div class="stat-value" id="totalBeats">0</div>
<div class="stat-label">Total Beats</div>
</div>
<div class="stat-box">
<div class="stat-value" id="sTaggedCount">0</div>
<div class="stat-label">S's Tagged</div>
</div>
<div class="stat-box">
<div class="stat-value">Ready</div>
<div class="stat-label">Status</div>
</div>
</div>
</div>

<div id="finalizeContent" class="finalize-content"></div>

<div class="btn-group">
<button class="btn btn-primary" onclick="exportScene()">Export Training Script</button>
</div>
</div>

<!-- WORKSHOP VIEW -->
<div id="workshopView" class="view">
<div class="workshop-container">
<div class="finalize-header">
<div class="finalize-title">Workshop Mode</div>
<button class="icon-btn" onclick="backToLibrary()">Back to Library</button>
</div>

<p style="opacity: 0.8; margin-bottom: 2rem; line-height: 1.6;">
Upload exported scenes to use during training sessions. Add discussion notes, teaching points, and analysis.
</p>

<div class="upload-zone" onclick="document.getElementById('fileUpload').click()">
<div class="upload-text">Click to Upload Scene</div>
<div class="upload-hint">Drag and drop or click to select</div>
<input type="file" id="fileUpload" accept=".txt" onchange="handleFileUpload(event)" style="display: none;">
</div>

<div id="workshopList" class="workshop-list"></div>
</div>
</div>

</div>

<script>
// HTML Escape utility function - CRITICAL for preventing XSS and syntax errors
function escapeHtml(unsafe) {
if (!unsafe) return '';
return unsafe
.toString()
.replace(/&/g, "&amp;")
.replace(/</g, "&lt;")
.replace(/>/g, "&gt;")
.replace(/"/g, "&quot;")
.replace(/'/g, "&#039;");
}

// Data Structure
let appData = {
scenes: [],
workshopItems: [],
currentSceneId: null
};

// Storage
function saveData() {
try {
localStorage.setItem('sceneBuilderData', JSON.stringify(appData));
} catch (e) {
console.error('Error saving data:', e);
alert('Error saving data. Your changes may not be preserved.');
}
}

function loadData() {
try {
const saved = localStorage.getItem('sceneBuilderData');
if (saved) {
appData = JSON.parse(saved);
}
} catch (e) {
console.error('Error loading data:', e);
alert('Error loading saved data. Starting fresh.');
}
}

// View Management
function showView(viewId) {
document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
document.getElementById(viewId).classList.add('active');
}

function backToLibrary() {
showView('libraryView');
renderSceneLibrary();
}

// Initialize
function init() {
loadData();
renderSceneLibrary();
}

// Scene Library
function renderSceneLibrary() {
const grid = document.getElementById('sceneGrid');
if (!appData.scenes || appData.scenes.length === 0) {
grid.innerHTML = '<div class="empty-state">No scenes yet. Create your first scene to get started.</div>';
return;
}

grid.innerHTML = appData.scenes.map(scene => `
<div class="scene-card" onclick="openScene('${scene.id}')">
<div class="scene-info">
<div class="scene-title-card">${escapeHtml(scene.title) || 'Untitled Scene'}</div>
<div class="scene-meta">
<span>${new Date(scene.created).toLocaleDateString()}</span>
<span>${scene.beats ? scene.beats.length : 0} beats</span>
</div>
</div>
<div class="scene-actions">
<span class="scene-status ${scene.status}">${scene.status}</span>
<button class="icon-btn delete" onclick="event.stopPropagation(); deleteScene('${scene.id}')">Delete</button>
</div>
</div>
`).join('');
}

function createNewScene() {
const scene = {
id: Date.now().toString(),
title: '',
status: 'setup',
created: new Date().toISOString(),
modified: new Date().toISOString(),
settingType: '',
locationName: '',
timingContext: '',
timeOfDay: '',
context: '',
characters: [],
beats: []
};
appData.scenes.push(scene);
appData.currentSceneId = scene.id;
saveData();
showView('setupView');
loadSceneSetup();
}

function openScene(id) {
appData.currentSceneId = id;
const scene = getCurrentScene();
if (scene.status === 'setup') {
showView('setupView');
loadSceneSetup();
} else if (scene.status === 'capturing') {
showView('captureView');
loadCaptureView();
} else if (scene.status === 'finalized' || scene.status === 'exported') {
showView('finalizeView');
loadFinalizeView();
}
}

function deleteScene(id) {
if (!confirm('Delete this scene? This cannot be undone.')) return;
appData.scenes = appData.scenes.filter(s => s.id !== id);
saveData();
renderSceneLibrary();
}

function getCurrentScene() {
return appData.scenes.find(s => s.id === appData.currentSceneId);
}

// Scene Setup
function loadSceneSetup() {
const scene = getCurrentScene();
document.getElementById('sceneTitle').value = scene.title || '';
document.getElementById('settingType').value = scene.settingType || '';
document.getElementById('locationName').value = scene.locationName || '';
document.getElementById('timingContext').value = scene.timingContext || '';
document.getElementById('timeOfDay').value = scene.timeOfDay || '';
document.getElementById('sceneContext').value = scene.context || '';
renderCharacterList();
}

function renderCharacterList() {
const scene = getCurrentScene();
const list = document.getElementById('characterList');
if (!scene.characters || scene.characters.length === 0) {
list.innerHTML = '<div class="empty-state">No characters yet. Add your first character.</div>';
return;
}
list.innerHTML = scene.characters.map((char, index) => `
<div class="character-item">
<div class="character-details">
<div class="character-name">${escapeHtml(char.name) || 'Unnamed'}</div>
<div class="character-info">${escapeHtml(char.role) || 'No role defined'}</div>
${char.motivation ? '<div class="character-info">Wants: ' + escapeHtml(char.motivation) + '</div>' : ''}
${char.emotional ? '<div class="character-info">State: ' + escapeHtml(char.emotional) + '</div>' : ''}
</div>
<div class="character-actions">
<button type="button" class="icon-btn" onclick="editCharacter(${index})">Edit</button>
<button type="button" class="icon-btn" onclick="removeCharacter(${index})">Remove</button>
</div>
</div>
`).join('');
}

function addCharacter() {
const name = prompt('Character Name:');
if (!name) return;
const role = prompt('Role/Description (e.g., Teacher, Customer, Friend):');
const motivation = prompt('What do they want in this moment?');
const emotional = prompt('Emotional state (e.g., Frustrated, Calm, Defensive):');

const scene = getCurrentScene();
if (!scene.characters) scene.characters = [];
scene.characters.push({ 
name: name,
role: role || '',
motivation: motivation || '',
emotional: emotional || '',
relationships: ''
});
scene.modified = new Date().toISOString();
saveData();
renderCharacterList();
}

function editCharacter(index) {
const scene = getCurrentScene();
const char = scene.characters[index];
const name = prompt('Character Name:', char.name);
if (name === null) return;
const role = prompt('Role/Description:', char.role);
if (role === null) return;
const motivation = prompt('What do they want?', char.motivation);
if (motivation === null) return;
const emotional = prompt('Emotional state:', char.emotional);
if (emotional === null) return;

char.name = name;
char.role = role;
char.motivation = motivation;
char.emotional = emotional;
scene.modified = new Date().toISOString();
saveData();
renderCharacterList();
}

function removeCharacter(index) {
if (!confirm('Remove this character?')) return;
const scene = getCurrentScene();
scene.characters.splice(index, 1);
scene.modified = new Date().toISOString();
saveData();
renderCharacterList();
}

function saveSetup() {
const scene = getCurrentScene();
scene.title = document.getElementById('sceneTitle').value;
scene.settingType = document.getElementById('settingType').value;
scene.locationName = document.getElementById('locationName').value;
scene.timingContext = document.getElementById('timingContext').value;
scene.timeOfDay = document.getElementById('timeOfDay').value;
scene.context = document.getElementById('sceneContext').value;
scene.modified = new Date().toISOString();
saveData();
alert('Progress saved!');
}

function completeSetup() {
saveSetup();
const scene = getCurrentScene();
scene.status = 'capturing';
saveData();
showView('captureView');
loadCaptureView();
}

// Capture Mode
function loadCaptureView() {
const scene = getCurrentScene();
populateCharacterSelect();
renderBeatsList();
updateBeatCount();
document.getElementById('beatDialogue').focus();
}

function populateCharacterSelect() {
const scene = getCurrentScene();
const select = document.getElementById('beatCharacter');
select.innerHTML = '<option value="">Select character...</option>';
if (scene.characters) {
scene.characters.forEach(char => {
select.innerHTML += `<option value="${escapeHtml(char.name)}">${escapeHtml(char.name)}</option>`;
});
}
}

function saveBeat() {
const title = document.getElementById('beatTitle').value.trim();
const character = document.getElementById('beatCharacter').value;
const dialogue = document.getElementById('beatDialogue').value.trim();
const action = document.getElementById('beatAction').value.trim();
const attitude = document.getElementById('beatAttitude').value.trim();

if (!title && !dialogue && !action) {
alert('Enter at least a beat title, dialogue, or action.');
return;
}

const scene = getCurrentScene();
const beat = {
id: Date.now().toString(),
title: title || 'Untitled Beat',
character: character,
dialogue: dialogue,
action: action,
attitude: attitude,
sUsed: [],
teachingNote: '',
timestamp: new Date().toISOString()
};

if (!scene.beats) scene.beats = [];
scene.beats.push(beat);
scene.modified = new Date().toISOString();
saveData();
clearBeatForm();
renderBeatsList();
updateBeatCount();
}

function clearBeatForm() {
document.getElementById('beatTitle').value = '';
document.getElementById('beatCharacter').value = '';
document.getElementById('beatDialogue').value = '';
document.getElementById('beatAction').value = '';
document.getElementById('beatAttitude').value = '';
document.getElementById('beatDialogue').focus();
}

function renderBeatsList() {
const scene = getCurrentScene();
const list = document.getElementById('beatsList');
if (!scene.beats || scene.beats.length === 0) {
list.innerHTML = '<div class="empty-state">No beats captured yet.</div>';
return;
}

list.innerHTML = scene.beats.map((beat, index) => `
<div class="beat-item">
<div class="beat-header">
<span class="beat-number">Beat ${index + 1}: ${escapeHtml(beat.title)}</span>
<button class="icon-btn" onclick="deleteBeat('${beat.id}')">Delete</button>
</div>
<div class="beat-content-preview">
${beat.character ? `<div class="beat-character">${escapeHtml(beat.character)}</div>` : ''}
${beat.dialogue ? `<div class="beat-dialogue">"${escapeHtml(beat.dialogue)}"</div>` : ''}
${beat.action ? `<div class="beat-action">${escapeHtml(beat.action)}</div>` : ''}
${beat.attitude ? `<div class="beat-action">Energy: ${escapeHtml(beat.attitude)}</div>` : ''}
</div>
</div>
`).join('');
}

function updateBeatCount() {
const scene = getCurrentScene();
document.getElementById('beatCount').textContent = scene.beats ? scene.beats.length : 0;
}

function deleteBeat(id) {
if (!confirm('Delete this beat?')) return;
const scene = getCurrentScene();
scene.beats = scene.beats.filter(b => b.id !== id);
scene.modified = new Date().toISOString();
saveData();
renderBeatsList();
updateBeatCount();
}

function moveToFinalize() {
const scene = getCurrentScene();
if (!scene.beats || scene.beats.length === 0) {
alert('Capture some beats first!');
return;
}
scene.status = 'finalized';
scene.modified = new Date().toISOString();
saveData();
showView('finalizeView');
loadFinalizeView();
}

function backToCapture() {
const scene = getCurrentScene();
scene.status = 'capturing';
saveData();
showView('captureView');
loadCaptureView();
}

// Finalize Mode
function loadFinalizeView() {
const scene = getCurrentScene();
updateFinalizeStats();
renderFinalizeBeats();
}

function updateFinalizeStats() {
const scene = getCurrentScene();
const beats = scene.beats || [];
document.getElementById('totalBeats').textContent = beats.length;
const sCount = beats.reduce((sum, b) => sum + (b.sUsed ? b.sUsed.length : 0), 0);
document.getElementById('sTaggedCount').textContent = sCount;
}

function renderFinalizeBeats() {
const scene = getCurrentScene();
const content = document.getElementById('finalizeContent');
if (!scene.beats || scene.beats.length === 0) {
content.innerHTML = '<div class="empty-state">No beats to finalize.</div>';
return;
}

content.innerHTML = scene.beats.map((beat, index) => {
const titleAttr = escapeHtml(beat.title);
const charAttr = escapeHtml(beat.character || '');
const dialogueText = escapeHtml(beat.dialogue || '');
const actionText = escapeHtml(beat.action || '');
const attitudeAttr = escapeHtml(beat.attitude || '');
const noteText = escapeHtml(beat.teachingNote || '');

return `
<div class="beat-editor">
<div class="beat-editor-header">
<div class="beat-title-edit">Beat ${index + 1}: ${titleAttr}</div>
<button class="icon-btn" onclick="deleteBeat('${beat.id}')">Delete</button>
</div>

<div class="form-row">
<div class="form-field">
<label>Beat Title</label>
<input type="text" value="${titleAttr}" onchange="updateBeatField('${beat.id}', 'title', this.value)">
</div>
<div class="form-field">
<label>Character</label>
<input type="text" value="${charAttr}" onchange="updateBeatField('${beat.id}', 'character', this.value)">
</div>
</div>

<div class="form-field">
<label>Dialogue (What They Say)</label>
<textarea onchange="updateBeatField('${beat.id}', 'dialogue', this.value)">${dialogueText}</textarea>
</div>

<div class="form-field">
<label>Action (What They Do / How They Say It)</label>
<textarea onchange="updateBeatField('${beat.id}', 'action', this.value)">${actionText}</textarea>
</div>

<div class="form-field">
<label>Energy / Attitude</label>
<input type="text" value="${attitudeAttr}" onchange="updateBeatField('${beat.id}', 'attitude', this.value)">
</div>

<div class="form-field">
<label>Which S's Could Have Been Used?</label>
<div class="s-selector">
${[1,2,3,4,5].map(num => {
const sNames = ['Slow Down', 'Size Up', 'Speak Smart', 'Select', 'Shut Down'];
const isChecked = beat.sUsed && beat.sUsed.includes(num);
return `
<div>
<input type="checkbox" class="s-checkbox" id="s${num}_${beat.id}" ${isChecked ? 'checked' : ''} onchange="toggleS('${beat.id}', ${num})">
<label for="s${num}_${beat.id}" class="s-label">
<span class="s-num">${num}</span>
<span class="s-name">${sNames[num-1]}</span>
</label>
</div>
`;
}).join('')}
</div>
</div>

<div class="form-field">
<label>Teaching Note</label>
<textarea placeholder="What's the lesson here? Why this S works or doesn't work..." onchange="updateBeatField('${beat.id}', 'teachingNote', this.value)">${noteText}</textarea>
</div>
</div>
`;
}).join('');
}

function updateBeatField(id, field, value) {
const scene = getCurrentScene();
const beat = scene.beats.find(b => b.id === id);
if (beat) {
beat[field] = value;
scene.modified = new Date().toISOString();
saveData();
updateFinalizeStats();
}
}

function toggleS(beatId, sNum) {
const scene = getCurrentScene();
const beat = scene.beats.find(b => b.id === beatId);
if (!beat) return;

if (!beat.sUsed) beat.sUsed = [];
const index = beat.sUsed.indexOf(sNum);
if (index > -1) {
beat.sUsed.splice(index, 1);
} else {
beat.sUsed.push(sNum);
beat.sUsed.sort();
}
scene.modified = new Date().toISOString();
saveData();
updateFinalizeStats();
}

// Export Scene
function exportScene() {
const scene = getCurrentScene();
if (!scene.beats || scene.beats.length === 0) {
alert('No beats to export!');
return;
}

const sNames = ['Slow Down', 'Size Up', 'Speak Smart', 'Select', 'Shut Down'];

let script = `THE 5 S'S TRAINING SCENE
${scene.title || 'Untitled Scene'}
Generated: ${new Date().toLocaleString()}

================================================================================
SCENE CONTEXT
================================================================================

Setting: ${scene.settingType || 'N/A'} - ${scene.locationName || 'N/A'}
Timing: ${scene.timingContext || 'N/A'}
Time of Day: ${scene.timeOfDay || 'N/A'}

${scene.context ? `Additional Context: ${scene.context}` : ''}

CHARACTERS:
${scene.characters && scene.characters.length > 0 ? scene.characters.map(c => `
${c.name}${c.role ? ' (' + c.role + ')' : ''}
${c.motivation ? '  Wants: ' + c.motivation : ''}
${c.emotional ? '  State: ' + c.emotional : ''}
`.trim()).join('\n\n') : 'No characters defined'}

================================================================================
THE WRONG VERSION (Without the 5 S's)
================================================================================

`;

scene.beats.forEach((beat, index) => {
script += `BEAT ${index + 1}: ${beat.title.toUpperCase()}\n`;
if (beat.character) script += `${beat.character}:\n`;
if (beat.dialogue) script += `"${beat.dialogue}"\n`;
if (beat.action) script += `[${beat.action}]\n`;
if (beat.attitude) script += `(Energy: ${beat.attitude})\n`;
script += '\n';
});

script += `
================================================================================
TEACHING ANALYSIS
================================================================================

How the 5 S's Could Transform This Scene:

`;

scene.beats.forEach((beat, index) => {
if (beat.sUsed && beat.sUsed.length > 0) {
script += `Beat ${index + 1}: ${beat.title}\n`;
script += `S's That Apply: ${beat.sUsed.map(s => `S${s} (${sNames[s-1]})`).join(', ')}\n`;
if (beat.teachingNote) script += `Note: ${beat.teachingNote}\n`;
script += '\n';
}
});

// Create download
const blob = new Blob([script], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `${scene.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${Date.now()}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);

scene.status = 'exported';
scene.modified = new Date().toISOString();
saveData();
alert('Script exported! Check your downloads folder.');
}

// Workshop Mode
function handleFileUpload(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
const item = {
id: Date.now().toString(),
filename: file.name,
content: e.target.result,
uploaded: new Date().toISOString(),
notes: ''
};
appData.workshopItems.push(item);
saveData();
renderWorkshopList();
};
reader.readAsText(file);
}

function renderWorkshopList() {
const list = document.getElementById('workshopList');
if (!appData.workshopItems || appData.workshopItems.length === 0) {
return;
}

list.innerHTML = appData.workshopItems.map(item => `
<div class="workshop-item">
<div class="workshop-header">
<div class="workshop-scene-title">${escapeHtml(item.filename)}</div>
<button class="icon-btn delete" onclick="deleteWorkshopItem('${item.id}')">Delete</button>
</div>
<div style="opacity: 0.6; font-size: 0.85rem; margin-bottom: 1rem;">
Uploaded ${new Date(item.uploaded).toLocaleDateString()}
</div>
<div class="workshop-notes">
<textarea class="notes-textarea" placeholder="Discussion notes, analysis, teaching points..." onchange="updateWorkshopNotes('${item.id}', this.value)">${escapeHtml(item.notes || '')}</textarea>
</div>
</div>
`).join('');
}

function updateWorkshopNotes(id, notes) {
const item = appData.workshopItems.find(i => i.id === id);
if (item) {
item.notes = notes;
saveData();
}
}

function deleteWorkshopItem(id) {
if (!confirm('Delete this workshop item?')) return;
appData.workshopItems = appData.workshopItems.filter(i => i.id !== id);
saveData();
renderWorkshopList();
}

// Initialize on load
init();
</script>
</body>
</html>
