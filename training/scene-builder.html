<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The 5 S's - Scene Builder</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600&family=Courier+Prime:wght@400;700&display=swap');

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Jost', sans-serif;
background: #0a0a0a;
color: #ffffff;
min-height: 100vh;
position: relative;
}

.gradient-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: radial-gradient(ellipse at center,
rgba(26, 71, 42, 0.6) 0%,
rgba(45, 80, 55, 0.4) 25%,
rgba(13, 35, 20, 0.8) 40%,
rgba(8, 20, 12, 0.95) 70%);
z-index: 0;
animation: breathe 4s infinite alternate ease-in-out;
}

@keyframes breathe {
0% { opacity: 0.4; }
100% { opacity: 0.6; }
}

.container {
position: relative;
z-index: 1;
max-width: 1400px;
margin: 0 auto;
padding: 2rem;
}

/* Header */
.header {
text-align: center;
margin-bottom: 2rem;
padding: 1.5rem;
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
backdrop-filter: blur(10px);
}

.header h1 {
font-size: 2rem;
font-weight: 300;
letter-spacing: 6px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.5rem;
}

.header p {
font-size: 0.9rem;
opacity: 0.7;
letter-spacing: 1px;
}

/* Mode Selector */
.mode-selector {
display: flex;
gap: 1rem;
margin-bottom: 2rem;
background: rgba(13, 25, 18, 0.6);
padding: 1rem;
border-radius: 12px;
border: 1px solid rgba(26, 71, 42, 0.4);
}

.mode-btn {
flex: 1;
padding: 1rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
text-align: center;
}

.mode-btn.active {
background: rgba(26, 71, 42, 0.8);
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 15px rgba(220, 180, 80, 0.3);
}

.mode-btn:hover {
transform: translateY(-2px);
}

.mode-label {
font-size: 0.85rem;
text-transform: uppercase;
letter-spacing: 2px;
opacity: 0.7;
margin-bottom: 0.3rem;
}

.mode-title {
font-size: 1.1rem;
font-weight: 400;
color: rgba(220, 180, 80, 0.95);
}

/* Capture Mode */
.capture-mode {
display: none;
}

.capture-mode.active {
display: block;
}

.quick-capture {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 1rem;
}

.quick-capture h2 {
font-size: 1.5rem;
font-weight: 300;
letter-spacing: 3px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 1.5rem;
text-align: center;
}

.capture-field {
margin-bottom: 1.5rem;
}

.capture-field label {
display: block;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
margin-bottom: 0.5rem;
}

.capture-field input,
.capture-field textarea,
.capture-field select {
width: 100%;
padding: 1rem;
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
color: #ffffff;
font-family: 'Jost', sans-serif;
font-size: 1.1rem;
}

.capture-field textarea {
min-height: 80px;
resize: vertical;
}

.capture-field input:focus,
.capture-field textarea:focus,
.capture-field select:focus {
outline: none;
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 10px rgba(220, 180, 80, 0.2);
}

/* Line Builder */
.line-builder {
background: rgba(13, 25, 18, 0.5);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}

.line-builder h3 {
font-size: 1.1rem;
font-weight: 300;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 1rem;
}

.line-type-selector {
display: flex;
gap: 1rem;
margin-bottom: 1.5rem;
}

.line-type-btn {
flex: 1;
padding: 0.8rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
cursor: pointer;
transition: all 0.2s ease;
text-align: center;
font-size: 0.9rem;
letter-spacing: 1px;
}

.line-type-btn.active {
background: rgba(26, 71, 42, 0.8);
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 10px rgba(220, 180, 80, 0.2);
}

.line-input-section {
display: none;
}

.line-input-section.active {
display: block;
}

.current-lines {
margin-top: 1.5rem;
padding-top: 1.5rem;
border-top: 1px solid rgba(26, 71, 42, 0.4);
}

.current-lines h4 {
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
margin-bottom: 1rem;
}

.line-item {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
padding: 1rem;
margin-bottom: 0.8rem;
display: flex;
justify-content: space-between;
align-items: flex-start;
}

.line-item.dialogue {
border-left: 3px solid rgba(220, 180, 80, 0.6);
}

.line-item.action {
border-left: 3px solid rgba(100, 150, 120, 0.6);
}

.line-item-content {
flex: 1;
}

.line-item-type {
font-size: 0.75rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.5;
margin-bottom: 0.3rem;
}

.line-item-character {
color: rgba(220, 180, 80, 0.95);
font-weight: 500;
margin-bottom: 0.3rem;
}

.line-item-text {
opacity: 0.9;
line-height: 1.5;
}

.line-item-actions {
display: flex;
gap: 0.5rem;
}

.btn {
padding: 1rem 2rem;
border: none;
border-radius: 8px;
cursor: pointer;
font-family: 'Jost', sans-serif;
font-size: 1rem;
letter-spacing: 1px;
text-transform: uppercase;
transition: all 0.3s ease;
}

.btn-primary {
background: rgba(26, 71, 42, 0.8);
border: 1px solid rgba(220, 180, 80, 0.6);
color: rgba(220, 180, 80, 0.95);
}

.btn-primary:hover {
background: rgba(26, 71, 42, 1);
box-shadow: 0 8px 20px rgba(220, 180, 80, 0.3);
transform: translateY(-2px);
}

.btn-secondary {
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
color: rgba(255, 255, 255, 0.9);
}

.btn-secondary:hover {
background: rgba(26, 71, 42, 0.5);
}

.btn-small {
padding: 0.5rem 1rem;
font-size: 0.85rem;
}

.icon-btn {
padding: 0.5rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 6px;
cursor: pointer;
transition: all 0.2s ease;
font-size: 0.9rem;
color: #ffffff;
}

.icon-btn:hover {
background: rgba(26, 71, 42, 0.6);
}

.capture-actions {
display: flex;
gap: 1rem;
margin-top: 2rem;
}

/* Beats Preview */
.beats-preview {
margin-top: 2rem;
}

.beats-preview h3 {
font-size: 1.2rem;
font-weight: 300;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 1rem;
}

.beat-item {
background: rgba(13, 25, 18, 0.5);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 8px;
padding: 1rem;
margin-bottom: 0.8rem;
}

.beat-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.8rem;
}

.beat-number {
color: rgba(220, 180, 80, 0.95);
font-weight: 500;
}

.beat-title {
flex: 1;
margin-left: 1rem;
font-size: 1.1rem;
}

.beat-lines-preview {
padding-left: 1rem;
border-left: 2px solid rgba(26, 71, 42, 0.4);
margin-top: 0.5rem;
}

.beat-line-preview {
margin-bottom: 0.5rem;
font-size: 0.9rem;
opacity: 0.8;
}

/* Finalize Mode */
.finalize-mode {
display: none;
}

.finalize-mode.active {
display: block;
}

.stats-bar {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
margin-bottom: 2rem;
}

.stat-card {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 12px;
padding: 1.5rem;
text-align: center;
}

.stat-value {
font-size: 2.5rem;
font-weight: 300;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.5rem;
}

.stat-label {
font-size: 0.85rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
}

.beat-editor {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 2rem;
margin-bottom: 2rem;
}

.beat-header-edit {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid rgba(26, 71, 42, 0.4);
}

.beat-title-edit {
font-size: 1.3rem;
font-weight: 300;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.95);
}

.form-group {
margin-bottom: 1.5rem;
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
}

.form-group label {
display: block;
font-size: 0.9rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
margin-bottom: 0.5rem;
}

.form-group input,
.form-group textarea,
.form-group select {
width: 100%;
padding: 1rem;
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
color: #ffffff;
font-family: 'Jost', sans-serif;
font-size: 1rem;
}

.form-group textarea {
min-height: 100px;
resize: vertical;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
outline: none;
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 10px rgba(220, 180, 80, 0.2);
}

.s-selector {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 0.8rem;
}

.s-checkbox {
display: none;
}

.s-label {
display: flex;
align-items: center;
padding: 0.8rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
cursor: pointer;
transition: all 0.2s ease;
}

.s-checkbox:checked + .s-label {
background: rgba(220, 180, 80, 0.3);
border-color: rgba(220, 180, 80, 0.6);
}

.s-num {
display: inline-flex;
align-items: center;
justify-content: center;
width: 30px;
height: 30px;
background: rgba(220, 180, 80, 0.3);
border-radius: 50%;
margin-right: 0.8rem;
font-weight: 600;
}

.s-name {
font-size: 0.9rem;
}

/* Playback Mode */
.playback-mode {
display: none;
}

.playback-mode.active {
display: block;
}

.playback-controls {
display: flex;
gap: 1rem;
margin-bottom: 2rem;
background: rgba(13, 25, 18, 0.6);
padding: 1rem;
border-radius: 12px;
border: 1px solid rgba(26, 71, 42, 0.4);
}

.version-btn {
flex: 1;
padding: 1rem;
background: rgba(26, 71, 42, 0.3);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
text-align: center;
}

.version-btn.active {
background: rgba(26, 71, 42, 0.8);
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 15px rgba(220, 180, 80, 0.3);
}

.s-tracker {
display: flex;
gap: 1rem;
margin-bottom: 2rem;
}

.s-item {
flex: 1;
background: rgba(13, 25, 18, 0.6);
border: 1px solid rgba(26, 71, 42, 0.4);
border-radius: 12px;
padding: 1rem;
text-align: center;
transition: all 0.3s ease;
}

.s-item.used {
background: rgba(220, 180, 80, 0.2);
border-color: rgba(220, 180, 80, 0.6);
box-shadow: 0 0 15px rgba(220, 180, 80, 0.2);
}

.s-number {
font-size: 2rem;
font-weight: 300;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 0.3rem;
}

.s-label-text {
font-size: 0.8rem;
text-transform: uppercase;
letter-spacing: 1px;
opacity: 0.7;
}

/* Script Display */
.script-display {
background: linear-gradient(135deg, rgba(13, 25, 18, 0.7) 0%, rgba(8, 18, 12, 0.9) 100%);
border: 1px solid rgba(26, 71, 42, 0.5);
border-radius: 16px;
padding: 3rem;
font-family: 'Courier Prime', monospace;
line-height: 1.8;
}

.script-beat {
margin-bottom: 3rem;
page-break-inside: avoid;
}

.script-beat-title {
text-align: center;
text-transform: uppercase;
font-weight: 700;
letter-spacing: 2px;
color: rgba(220, 180, 80, 0.95);
margin-bottom: 2rem;
font-size: 1.1rem;
}

.script-line {
margin-bottom: 1.5rem;
}

.script-character {
text-transform: uppercase;
margin-left: 40%;
margin-bottom: 0.3rem;
font-weight: 700;
color: rgba(220, 180, 80, 0.95);
}

.script-dialogue {
margin-left: 25%;
margin-right: 25%;
}

.script-parenthetical {
margin-left: 30%;
margin-right: 30%;
opacity: 0.8;
font-style: italic;
}

.script-action {
margin-top: 1rem;
margin-bottom: 1rem;
opacity: 0.9;
}

.script-s-indicator {
display: inline-block;
background: rgba(220, 180, 80, 0.3);
padding: 0.2rem 0.5rem;
border-radius: 4px;
font-size: 0.8rem;
margin-left: 0.5rem;
}

.script-teaching-note {
margin-top: 1.5rem;
padding: 1rem;
background: rgba(220, 180, 80, 0.1);
border-left: 3px solid rgba(220, 180, 80, 0.6);
border-radius: 4px;
font-family: 'Jost', sans-serif;
font-size: 0.95rem;
line-height: 1.6;
}

.export-actions {
display: flex;
gap: 1rem;
margin-top: 2rem;
justify-content: center;
}

.text-center {
text-align: center;
}
</style>
</head>
<body>
<div class="gradient-bg"></div>

<div class="container">
<div class="header">
<h1 id="scenarioTitle">SCENE BUILDER</h1>
<p id="scenarioSubtitle">THE 5 S's COLLABORATIVE TRAINING</p>
</div>

<div class="mode-selector">
<div class="mode-btn active" onclick="switchMode('capture')">
<div class="mode-label">Step 1</div>
<div class="mode-title">Capture</div>
</div>
<div class="mode-btn" onclick="switchMode('finalize')">
<div class="mode-label">Step 2</div>
<div class="mode-title">Finalize</div>
</div>
<div class="mode-btn" onclick="switchMode('playback')">
<div class="mode-label">Step 3</div>
<div class="mode-title">Playback</div>
</div>
</div>

<!-- CAPTURE MODE -->
<div class="capture-mode active" id="captureMode">
<div class="quick-capture">
<h2>New Beat</h2>

<div class="capture-field">
<label>Beat Title</label>
<input type="text" id="beatTitle" placeholder="e.g., Opening Confrontation">
</div>

<div class="line-builder">
<h3>Build Your Beat Line by Line</h3>

<div class="line-type-selector">
<div class="line-type-btn active" onclick="switchLineType('dialogue')">
Dialogue
</div>
<div class="line-type-btn" onclick="switchLineType('action')">
Action
</div>
</div>

<div class="line-input-section active" id="dialogueInput">
<div class="capture-field">
<label>Character Name</label>
<input type="text" id="dialogueCharacter" placeholder="e.g., ALEX" list="characterSuggestions">
<datalist id="characterSuggestions">
<!-- Character names from setup will populate here -->
</datalist>
</div>
<div class="capture-field">
<label>Dialogue</label>
<textarea id="dialogueText" placeholder="What the character says..."></textarea>
</div>
<div class="capture-field">
<label>Parenthetical (Optional)</label>
<input type="text" id="dialogueParenthetical" placeholder="(nervous) or (to the bartender)">
</div>
<button class="btn btn-secondary btn-small" onclick="addDialogueLine()">+ Add Dialogue</button>
</div>

<div class="line-input-section" id="actionInput">
<div class="capture-field">
<label>Action / Stage Direction</label>
<textarea id="actionText" placeholder="Describe what happens visually..."></textarea>
</div>
<button class="btn btn-secondary btn-small" onclick="addActionLine()">+ Add Action</button>
</div>

<div class="current-lines" id="currentLines" style="display: none;">
<h4>Lines in this beat:</h4>
<div id="linesContainer"></div>
</div>
</div>

<div class="capture-field">
<label>Beat Version</label>
<select id="beatVersion">
<option value="wrong">Wrong Version (Without 5 S's)</option>
<option value="right">Right Version (With 5 S's)</option>
<option value="both">Both Versions</option>
</select>
</div>

<div class="capture-actions">
<button class="btn btn-secondary" onclick="clearBeat()">Clear</button>
<button class="btn btn-primary" onclick="saveBeat()">Save Beat</button>
</div>
</div>

<div class="beats-preview">
<h3>Captured Beats (<span id="beatCount">0</span>)</h3>
<div id="beatsList"></div>
</div>
</div>

<!-- FINALIZE MODE -->
<div class="finalize-mode" id="finalizeMode">
<div class="stats-bar">
<div class="stat-card">
<div class="stat-value" id="totalBeats">0</div>
<div class="stat-label">Total Beats</div>
</div>
<div class="stat-card">
<div class="stat-value" id="wrongBeats">0</div>
<div class="stat-label">Wrong Version</div>
</div>
<div class="stat-card">
<div class="stat-value" id="rightBeats">0</div>
<div class="stat-label">Right Version</div>
</div>
<div class="stat-card">
<div class="stat-value" id="sUsageCount">0</div>
<div class="stat-label">S's Used</div>
</div>
</div>

<div id="finalizeContent"></div>

<div class="export-actions">
<button class="btn btn-secondary" onclick="clearAllData()">Clear All Data</button>
</div>
</div>

<!-- PLAYBACK MODE -->
<div class="playback-mode" id="playbackMode">
<div class="playback-controls">
<div class="version-btn active" onclick="switchPlaybackVersion('wrong', event)">
<div class="mode-label">Version A</div>
<div class="mode-title">Without 5 S's</div>
</div>
<div class="version-btn" onclick="switchPlaybackVersion('right', event)">
<div class="mode-label">Version B</div>
<div class="mode-title">With 5 S's</div>
</div>
</div>

<div class="s-tracker">
<div class="s-item" id="s1">
<div class="s-number">1</div>
<div class="s-label-text">Slow Down</div>
</div>
<div class="s-item" id="s2">
<div class="s-number">2</div>
<div class="s-label-text">Size Up</div>
</div>
<div class="s-item" id="s3">
<div class="s-number">3</div>
<div class="s-label-text">Speak Smart</div>
</div>
<div class="s-item" id="s4">
<div class="s-number">4</div>
<div class="s-label-text">Select</div>
</div>
<div class="s-item" id="s5">
<div class="s-number">5</div>
<div class="s-label-text">Shut Down</div>
</div>
</div>

<div id="playbackContent"></div>

<div class="export-actions">
<button class="btn btn-primary" onclick="exportScript()">üìÑ Export Script</button>
</div>
</div>
</div>

<script>
// Global state
let sceneData = {
beats: [],
metadata: {
created: new Date().toISOString(),
modified: new Date().toISOString()
}
};

let setupData = null;
let currentBeatLines = [];
let currentLineType = 'dialogue';
let currentPlaybackVersion = 'wrong';
let nextBeatId = 1;

// Load setup data from sessionStorage
function loadSetupData() {
const saved = sessionStorage.getItem('scene_setup');
if (saved) {
setupData = JSON.parse(saved);
// Update header with scenario title
if (setupData.scenarioTitle) {
document.getElementById('scenarioTitle').textContent = setupData.scenarioTitle.toUpperCase();
}
if (setupData.setting) {
document.getElementById('scenarioSubtitle').textContent = setupData.setting;
}
// Populate character suggestions
populateCharacterSuggestions();
}
}

// Populate character name suggestions for autocomplete
function populateCharacterSuggestions() {
if (!setupData || !setupData.characters) return;
const datalist = document.getElementById('characterSuggestions');
if (!datalist) return;
datalist.innerHTML = setupData.characters.map(char => 
`<option value="${char.name}">`
).join('');
}

// Load data from localStorage
function loadData() {
const saved = localStorage.getItem('sceneBuilderData');
if (saved) {
sceneData = JSON.parse(saved);
nextBeatId = Math.max(...sceneData.beats.map(b => b.id), 0) + 1;
}
updateBeatsList();
updateFinalizeView();
updatePlaybackView();
}

// Save data to localStorage
function saveData() {
sceneData.metadata.modified = new Date().toISOString();
localStorage.setItem('sceneBuilderData', JSON.stringify(sceneData));
}

// Switch mode
function switchMode(mode) {
document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.capture-mode, .finalize-mode, .playback-mode').forEach(el => el.classList.remove('active'));

event.target.closest('.mode-btn').classList.add('active');
document.getElementById(mode + 'Mode').classList.add('active');

if (mode === 'finalize') updateFinalizeView();
if (mode === 'playback') updatePlaybackView();
}

// Switch line type
function switchLineType(type) {
currentLineType = type;
document.querySelectorAll('.line-type-btn').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.line-input-section').forEach(section => section.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(type + 'Input').classList.add('active');
}

// Add dialogue line
function addDialogueLine() {
const character = document.getElementById('dialogueCharacter').value.trim();
const text = document.getElementById('dialogueText').value.trim();
const parenthetical = document.getElementById('dialogueParenthetical').value.trim();

if (!character || !text) {
alert('Please enter both character name and dialogue');
return;
}

currentBeatLines.push({
type: 'dialogue',
character: character,
text: text,
parenthetical: parenthetical
});

document.getElementById('dialogueCharacter').value = '';
document.getElementById('dialogueText').value = '';
document.getElementById('dialogueParenthetical').value = '';
document.getElementById('dialogueText').focus();

updateCurrentLines();
}

// Add action line
function addActionLine() {
const text = document.getElementById('actionText').value.trim();

if (!text) {
alert('Please enter action description');
return;
}

currentBeatLines.push({
type: 'action',
text: text
});

document.getElementById('actionText').value = '';
document.getElementById('actionText').focus();

updateCurrentLines();
}

// Update current lines display
function updateCurrentLines() {
const container = document.getElementById('linesContainer');
const currentLinesSection = document.getElementById('currentLines');

if (currentBeatLines.length === 0) {
currentLinesSection.style.display = 'none';
return;
}

currentLinesSection.style.display = 'block';

container.innerHTML = currentBeatLines.map((line, index) => {
if (line.type === 'dialogue') {
return `
<div class="line-item dialogue">
<div class="line-item-content">
<div class="line-item-type">Dialogue</div>
<div class="line-item-character">${line.character}</div>
${line.parenthetical ? `<div class="line-item-text" style="font-style: italic; opacity: 0.7;">${line.parenthetical}</div>` : ''}
<div class="line-item-text">${line.text}</div>
</div>
<div class="line-item-actions">
<button class="icon-btn" onclick="deleteLine(${index})">üóëÔ∏è</button>
</div>
</div>
`;
} else {
return `
<div class="line-item action">
<div class="line-item-content">
<div class="line-item-type">Action</div>
<div class="line-item-text">${line.text}</div>
</div>
<div class="line-item-actions">
<button class="icon-btn" onclick="deleteLine(${index})">üóëÔ∏è</button>
</div>
</div>
`;
}
}).join('');
}

// Delete line from current beat
function deleteLine(index) {
currentBeatLines.splice(index, 1);
updateCurrentLines();
}

// Save beat
function saveBeat() {
const title = document.getElementById('beatTitle').value.trim();
const version = document.getElementById('beatVersion').value;

if (!title) {
alert('Please enter a beat title');
return;
}

if (currentBeatLines.length === 0) {
alert('Please add at least one dialogue or action line');
return;
}

const beat = {
id: nextBeatId++,
title: title,
lines: [...currentBeatLines],
version: version,
sUsed: [],
teachingNote: '',
created: new Date().toISOString()
};

sceneData.beats.push(beat);
saveData();
updateBeatsList();

// Clear form
clearBeat();

// Show success feedback
const btn = event.target;
const originalText = btn.textContent;
btn.textContent = '‚úì Saved!';
btn.style.background = 'rgba(100, 200, 100, 0.5)';
setTimeout(() => {
btn.textContent = originalText;
btn.style.background = '';
}, 1000);
}

// Clear beat form
function clearBeat() {
document.getElementById('beatTitle').value = '';
document.getElementById('dialogueCharacter').value = '';
document.getElementById('dialogueText').value = '';
document.getElementById('dialogueParenthetical').value = '';
document.getElementById('actionText').value = '';
currentBeatLines = [];
updateCurrentLines();
document.getElementById('beatTitle').focus();
}

// Update beats list
function updateBeatsList() {
const list = document.getElementById('beatsList');
const count = document.getElementById('beatCount');
count.textContent = sceneData.beats.length;

if (sceneData.beats.length === 0) {
list.innerHTML = '<p style="opacity: 0.5; text-align: center; padding: 2rem;">No beats captured yet.</p>';
return;
}

list.innerHTML = sceneData.beats.map((beat, index) => `
<div class="beat-item">
<div class="beat-header">
<span class="beat-number">Beat ${index + 1}</span>
<span class="beat-title">${beat.title}</span>
<div>
<button class="icon-btn" onclick="deleteBeat(${beat.id})" title="Delete">üóëÔ∏è</button>
</div>
</div>
<div class="beat-lines-preview">
${beat.lines.slice(0, 3).map(line => {
if (line.type === 'dialogue') {
return `<div class="beat-line-preview"><strong>${line.character}:</strong> ${line.text.substring(0, 60)}${line.text.length > 60 ? '...' : ''}</div>`;
} else {
return `<div class="beat-line-preview"><em>${line.text.substring(0, 60)}${line.text.length > 60 ? '...' : ''}</em></div>`;
}
}).join('')}
${beat.lines.length > 3 ? `<div class="beat-line-preview" style="opacity: 0.5;">+ ${beat.lines.length - 3} more lines...</div>` : ''}
</div>
</div>
`).join('');
}

// Delete beat
function deleteBeat(id) {
if (!confirm('Delete this beat?')) return;
sceneData.beats = sceneData.beats.filter(b => b.id !== id);
saveData();
updateBeatsList();
updateFinalizeView();
updatePlaybackView();
}

// Update finalize view
function updateFinalizeView() {
document.getElementById('totalBeats').textContent = sceneData.beats.length;
document.getElementById('wrongBeats').textContent = sceneData.beats.filter(b => b.version === 'wrong' || b.version === 'both').length;
document.getElementById('rightBeats').textContent = sceneData.beats.filter(b => b.version === 'right' || b.version === 'both').length;
document.getElementById('sUsageCount').textContent = sceneData.beats.reduce((sum, b) => sum + (b.sUsed ? b.sUsed.length : 0), 0);

const content = document.getElementById('finalizeContent');
if (sceneData.beats.length === 0) {
content.innerHTML = '<p class="text-center" style="opacity: 0.7; padding: 2rem;">Capture some beats first, then come here to finalize them.</p>';
return;
}

content.innerHTML = sceneData.beats.map((beat, index) => `
<div class="beat-editor">
<div class="beat-header-edit">
<div class="beat-title-edit">Beat ${index + 1}: ${beat.title}</div>
<button class="icon-btn" onclick="deleteBeat(${beat.id})">üóëÔ∏è Delete</button>
</div>

<div class="form-group">
<label>Beat Title</label>
<input type="text" value="${beat.title}" onchange="updateBeatField(${beat.id}, 'title', this.value)">
</div>

<div class="form-group">
<label>Beat Lines (${beat.lines.length} lines)</label>
<div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; border: 1px solid rgba(26, 71, 42, 0.5);">
${beat.lines.map((line, lineIndex) => {
if (line.type === 'dialogue') {
return `
<div style="margin-bottom: 1rem; padding: 0.8rem; background: rgba(220, 180, 80, 0.1); border-left: 3px solid rgba(220, 180, 80, 0.6); border-radius: 4px;">
<div style="font-weight: 600; color: rgba(220, 180, 80, 0.95); margin-bottom: 0.3rem;">${line.character}</div>
${line.parenthetical ? `<div style="font-style: italic; opacity: 0.7; margin-bottom: 0.3rem;">${line.parenthetical}</div>` : ''}
<div>${line.text}</div>
</div>
`;
} else {
return `
<div style="margin-bottom: 1rem; padding: 0.8rem; background: rgba(100, 150, 120, 0.1); border-left: 3px solid rgba(100, 150, 120, 0.6); border-radius: 4px;">
<div style="font-style: italic; opacity: 0.9;">${line.text}</div>
</div>
`;
}
}).join('')}
</div>
</div>

<div class="form-group">
<label>Version</label>
<select onchange="updateBeatField(${beat.id}, 'version', this.value)">
<option value="wrong" ${beat.version === 'wrong' ? 'selected' : ''}>Wrong Version (Without 5 S's)</option>
<option value="right" ${beat.version === 'right' ? 'selected' : ''}>Right Version (With 5 S's)</option>
<option value="both" ${beat.version === 'both' ? 'selected' : ''}>Both Versions</option>
</select>
</div>

<div class="form-group">
<label>Which S's Are Used? (Select for Right Version)</label>
<div class="s-selector">
${[1,2,3,4,5].map(num => {
const sNames = ['Slow Down', 'Size Up', 'Speak Smart', 'Select', 'Shut Down'];
const isChecked = beat.sUsed && beat.sUsed.includes(num);
return `
<div>
<input type="checkbox" class="s-checkbox" id="s${num}_${beat.id}" ${isChecked ? 'checked' : ''} onchange="toggleSUsed(${beat.id}, ${num})">
<label for="s${num}_${beat.id}" class="s-label">
<span class="s-num">${num}</span>
<span class="s-name">${sNames[num-1]}</span>
</label>
</div>
`;
}).join('')}
</div>
</div>

<div class="form-group">
<label>Teaching Note (Why this S works/doesn't work)</label>
<textarea placeholder="What's the lesson here?" onchange="updateBeatField(${beat.id}, 'teachingNote', this.value)">${beat.teachingNote || ''}</textarea>
</div>
</div>
`).join('');
}

// Update beat field
function updateBeatField(id, field, value) {
const beat = sceneData.beats.find(b => b.id === id);
if (beat) {
beat[field] = value;
saveData();
updatePlaybackView();
}
}

// Toggle S used
function toggleSUsed(beatId, sNum) {
const beat = sceneData.beats.find(b => b.id === beatId);
if (!beat) return;

if (!beat.sUsed) beat.sUsed = [];

const index = beat.sUsed.indexOf(sNum);
if (index > -1) {
beat.sUsed.splice(index, 1);
} else {
beat.sUsed.push(sNum);
beat.sUsed.sort();
}

saveData();
updateFinalizeView();
updatePlaybackView();
}

// Update playback view
function updatePlaybackView() {
const content = document.getElementById('playbackContent');

// Clear S tracking
for (let i = 1; i <= 5; i++) {
document.getElementById(`s${i}`).classList.remove('used');
}

// Filter beats by current version
const beats = sceneData.beats.filter(b => b.version === currentPlaybackVersion || b.version === 'both');

if (beats.length === 0) {
content.innerHTML = '<p class="text-center" style="opacity: 0.7; padding: 2rem;">No beats for this version yet.</p>';
return;
}

content.innerHTML = beats.map(beat => {
// Mark S's as used if in right version
if (currentPlaybackVersion === 'right' && beat.sUsed) {
beat.sUsed.forEach(s => {
setTimeout(() => {
document.getElementById(`s${s}`).classList.add('used');
}, 100);
});
}

return `
<div class="script-display">
<div class="script-beat">
<div class="script-beat-title">${beat.title}</div>
${beat.lines.map(line => {
if (line.type === 'dialogue') {
return `
<div class="script-line">
<div class="script-character">${line.character}</div>
${line.parenthetical ? `<div class="script-parenthetical">${line.parenthetical}</div>` : ''}
<div class="script-dialogue">
${line.text}
${currentPlaybackVersion === 'right' && beat.sUsed && beat.sUsed.length > 0 ? 
beat.sUsed.map(s => `<span class="script-s-indicator">S${s}</span>`).join('') : ''}
</div>
</div>
`;
} else {
return `<div class="script-action">${line.text}</div>`;
}
}).join('')}
${beat.teachingNote && currentPlaybackVersion === 'right' ? 
`<div class="script-teaching-note">üí° <strong>Teaching Note:</strong> ${beat.teachingNote}</div>` : ''}
</div>
</div>
`;
}).join('');
}

// Switch playback version
function switchPlaybackVersion(version, event) {
currentPlaybackVersion = version;
document.querySelectorAll('.version-btn').forEach(btn => btn.classList.remove('active'));
if (event && event.target) {
event.target.closest('.version-btn').classList.add('active');
}
updatePlaybackView();
}

// Export script
function exportScript() {
if (sceneData.beats.length === 0) {
alert('No beats to export yet!');
return;
}

const wrongBeats = sceneData.beats.filter(b => b.version === 'wrong' || b.version === 'both');
const rightBeats = sceneData.beats.filter(b => b.version === 'right' || b.version === 'both');

// Use scenario title from setup, or default
const scenarioTitle = (setupData && setupData.scenarioTitle) ? setupData.scenarioTitle.toUpperCase() : 'SCENE';

let script = `${scenarioTitle} - SCENE SCRIPT
Generated: ${new Date().toLocaleString()}
Total Beats: ${sceneData.beats.length}
${setupData && setupData.setting ? `Setting: ${setupData.setting}\n` : ''}
${setupData && setupData.context ? `Context: ${setupData.context}\n` : ''}

================================================================================
VERSION A: WITHOUT THE 5 S's (The Wrong Way)
================================================================================

`;

wrongBeats.forEach((beat, index) => {
script += `${beat.title.toUpperCase()}\n\n`;
beat.lines.forEach(line => {
if (line.type === 'dialogue') {
script += `                    ${line.character.toUpperCase()}\n`;
if (line.parenthetical) {
script += `          ${line.parenthetical}\n`;
}
script += `     ${line.text}\n\n`;
} else {
script += `${line.text}\n\n`;
}
});
script += `\n`;
});

script += `
================================================================================
VERSION B: WITH THE 5 S's (The Right Way)
================================================================================

`;

rightBeats.forEach((beat, index) => {
script += `${beat.title.toUpperCase()}\n\n`;
beat.lines.forEach(line => {
if (line.type === 'dialogue') {
script += `                    ${line.character.toUpperCase()}\n`;
if (line.parenthetical) {
script += `          ${line.parenthetical}\n`;
}
script += `     ${line.text}`;
if (beat.sUsed && beat.sUsed.length > 0) {
const sNames = ['Slow Down', 'Size Up', 'Speak Smart', 'Select', 'Shut Down'];
script += ` [${beat.sUsed.map(s => `S${s}: ${sNames[s-1]}`).join(', ')}]`;
}
script += `\n\n`;
} else {
script += `${line.text}\n\n`;
}
});
if (beat.teachingNote) {
script += `TEACHING NOTE: ${beat.teachingNote}\n\n`;
}
script += `\n`;
});

// Create downloadable file
const blob = new Blob([script], { type: 'text/plain' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `${setupData && setupData.scenarioTitle ? setupData.scenarioTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-') : 'scene-script'}-${Date.now()}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);

alert('Script exported in professional format! Check your downloads folder.');
}

// Clear all data
function clearAllData() {
if (!confirm('This will delete ALL captured beats and start over. Are you sure?')) return;
if (!confirm('Really sure? This cannot be undone.')) return;

sceneData = {
beats: [],
metadata: {
created: new Date().toISOString(),
modified: new Date().toISOString()
}
};
nextBeatId = 1;
saveData();
updateBeatsList();
updateFinalizeView();
updatePlaybackView();
alert('All data cleared. Starting fresh.');
}

// Initialize
loadSetupData();
loadData();
</script>
</body>
</html>
